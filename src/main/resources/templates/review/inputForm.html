<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Î¶¨Î∑∞ ÏûëÏÑ±</title>

    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">

    <style>
        h2 {
            font-weight: 700;
            color: #ffffff;
        }

        /* ----- Î©îÏù∏ Ïπ¥Îìú ----- */
        .review-container {
            background: #2a2c34;
            padding: 40px;
            border-radius: 22px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.55);
            max-width: 820px;
            margin: auto;
        }

        /* ----- ÏûÖÎ†•Ï∞Ω ----- */
        .form-control {
            background: #1f1f25 !important;
            border: none;
            color: #fff !important;
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 1rem;
        }

        .form-control:focus {
            background: #1f1f25;
            outline: none;
            box-shadow: 0 0 0 2px #6f6bff;
        }

        /* ----- ÏûêÎèôÏôÑÏÑ± Î∞ïÏä§ (Îã§ÌÅ¨ Ïä§ÌÉÄÏùº) ----- */
        .autocomplete-box {
            position: absolute;
            background: #2e2f36;
            border-radius: 12px;
            width: 100%;
            z-index: 1000;
            max-height: 280px;
            overflow-y: auto;
            box-shadow: 0 6px 18px rgba(0,0,0,0.45);
        }

        .autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            gap: 14px;
            align-items: center;
            color: #ddd;
        }

        .autocomplete-item:hover {
            background: #3a3c46;
        }

        .autocomplete-item img {
            width: 42px;
            height: 58px;
            border-radius: 6px;
            object-fit: cover;
        }

        /* ----- ÎØ∏Î¶¨Î≥¥Í∏∞ Ïπ¥Îìú ----- */
        #previewBox .card {
            background: #1f2026;
            border-radius: 18px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.4);
            border: 1px solid #2e2f36;
        }

        #previewBox img {
            width: 130px;
            border-radius: 10px;
        }

        #previewTitle {
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
        }

        #previewAuthor {
            color: #b5b5b5;
            font-size: 0.9rem;
        }

        /* ----- Îì±Î°ù Î≤ÑÌäº ----- */
        .submit-btn {
            background: #6f6bff;
            padding: 12px 18px;
            border-radius: 12px;
            width: 100%;
            border: none;
            color: #fff;
            font-weight: 600;
            transition: 0.2s;
        }

        .submit-btn:hover {
            background: #837fff;
        }
    </style>
</head>

<body>

<div class="container my-5">
    <div class="review-container">

        <h2 class="mb-4">üìö Î¶¨Î∑∞ ÏûëÏÑ±</h2>

        <form method="post" th:object="${reviewDto}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <!-- Î¶¨Î∑∞ Ï†úÎ™© -->
            <div class="mb-4">
                <label><strong>Î¶¨Î∑∞ Ï†úÎ™©</strong></label>
                <input th:field="*{reviewTitle}" class="form-control">
            </div>

            <!-- Ï±Ö Í≤ÄÏÉâ -->
            <div class="mb-4" style="position: relative;">
                <label><strong>Ï±Ö Ï†úÎ™© Í≤ÄÏÉâ</strong></label>
                <input th:field="*{bookTitle}" id="bookTitle" class="form-control" autocomplete="off">
                <div id="searchResult" class="autocomplete-box" style="display:none;"></div>
            </div>

            <!-- hidden ÌïÑÎìú -->
            <input type="hidden" th:field="*{bookAuthor}" id="bookAuthor">
            <input type="hidden" th:field="*{bookImage}" id="bookImage">

            <!-- ÎØ∏Î¶¨Î≥¥Í∏∞ -->
            <div id="previewBox" class="mt-4" style="display:none;">
                <div class="card p-3">
                    <div class="d-flex gap-3 align-items-center">
                        <img id="previewImage">
                        <div>
                            <h5 id="previewTitle"></h5>
                            <p id="previewAuthor"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÎÇ¥Ïö© -->
            <div class="mt-4 mb-4">
                <label><strong>ÎÇ¥Ïö©</strong></label>
                <textarea th:field="*{reviewContent}" class="form-control" rows="7"></textarea>
            </div>

            <button class="submit-btn">Î¶¨Î∑∞ Îì±Î°ù</button>
        </form>

    </div>
</div>

<script>
    document.getElementById("bookTitle").addEventListener("keyup", async function () {

        const query = this.value.trim();
        const box = document.getElementById("searchResult");

        if (query.length < 2) {
            box.style.display = "none";
            return;
        }

        const res = await fetch(`/api/books/search?query=${encodeURIComponent(query)}`);
        const data = await res.json();

        box.innerHTML = "";
        box.style.display = "block";

        data.items.forEach(book => {
            const item = document.createElement("div");
            item.className = "autocomplete-item";

            item.innerHTML = `
                <img src="${book.image}">
                <div>
                    <strong>${book.title}</strong><br>
                    <small>${book.author}</small>
                </div>
            `;

            item.onclick = () => {
                document.getElementById("bookTitle").value = book.title;
                document.getElementById("bookAuthor").value = book.author;
                document.getElementById("bookImage").value = book.image;

                document.getElementById("previewImage").src = book.image;
                document.getElementById("previewTitle").innerText = book.title;
                document.getElementById("previewAuthor").innerText = book.author;
                document.getElementById("previewBox").style.display = "block";

                box.style.display = "none";
            };

            box.appendChild(item);
        });
    });
</script>

</body>
</html>
