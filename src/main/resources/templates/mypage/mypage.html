<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
    <!-- mypage ì „ìš© css -->
    <link rel="stylesheet" th:href="@{/css/mypage.css}">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<div layout:fragment="content" class="container my-5">


    <h2 class="fw-bold mb-4"><i class="bi bi-book"></i>
        ë‚´ ì„œì¬</h2>

    <!-- ê·¸ë˜í”„ ì˜ì—­ -->
    <div class="row g-4">

        <div class="col-lg-6">

            <div class="card-dark mb-4 equal-card">
                <h5 class="section-title"><i class="bi bi-bar-chart-line"></i>
                    ì˜¬í•´ ì½ì€ ì±…</h5>
                <canvas id="yearChart"></canvas>
            </div>

            <div class="card-dark equal-card">
                <h5 class="section-title"><i class="bi bi-graph-up"></i>ì‘ë…„ ë…ì„œëŸ‰ ë¹„êµ</h5>
                <canvas id="compareChart"></canvas>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card-dark mb-4 equal-card">

                <h5 class="section-title">
                    <i class="bi bi-pie-chart"></i>
                    ë…ì„œ ì „í™˜ìœ¨ (ì˜¬í•´)
                </h5>

                <div class="conversion-wrapper">
                    <canvas id="conversionChart"></canvas>

                    <div class="conversion-center">
                        <strong class="conversion-percent">
                            [[${( (#lists.size(completedList) * 100) /
                            (#lists.size(readingList) + #lists.size(completedList)) )}]]%
                        </strong>
                        <div class="text-muted-sm">ì™„ë… ë‹¬ì„±ë¥ </div>
                    </div>
                </div>

            </div>

            <div class="card-dark mb-4 equal-card">

                <h5 class="section-title">
                    <i class="bi bi-clock-history"></i>
                    í‰ê·  ì™„ë… ì†Œìš” ì‹œê°„
                </h5>

                <div class="avg-read-content">
                    <div class="avg-read-value">
                        <span th:text="${#numbers.formatDecimal(avgReadDays, 1, 1)}"></span>
                        <span class="avg-read-unit">ì¼</span>
                    </div>

                    <div class="avg-read-desc">
                        ì™„ë… ê¸°ì¤€ í‰ê·  ë…ì„œ ê¸°ê°„
                    </div>
                </div>

            </div>
        </div>
    </div>
    <br>


    <div class="row g-4">

        <!-- ì½ì„ ì˜ˆì • -->
        <div class="col-md-4">
            <div class="book-status-card" onclick="location.href='/to-read'">
                <h5>ğŸ“• ì½ì„ ì˜ˆì •</h5>

                <div class="status-count">
                <span class="count-number"
                      th:text="${#lists.size(toReadList)}"></span>
                    <span class="count-label">ê¶Œ</span>
                </div>
            </div>
        </div>

        <!-- ì½ëŠ” ì¤‘ -->
        <div class="col-md-4">
            <div class="book-status-card" onclick="location.href='/reading'">
                <h5>ğŸ“˜ ì½ëŠ” ì¤‘</h5>

                <div class="status-count">
                <span class="count-number"
                      th:text="${#lists.size(readingList)}"></span>
                    <span class="count-label">ê¶Œ</span>
                </div>
            </div>
        </div>

        <!-- ì™„ë… -->
        <div class="col-md-4">
            <div class="book-status-card" onclick="location.href='/completed'">
                <h5>ğŸ“— ì™„ë…</h5>

                <div class="status-count">
                <span class="count-number"
                      th:text="${#lists.size(completedList)}"></span>
                    <span class="count-label">ê¶Œ</span>
                </div>
            </div>
        </div>
    </div>
</div>


<!---->
<div id="thisYearCounts"
     th:data-values="${#strings.arrayJoin(thisYearCounts, ',')}">
</div>
<div id="lastYearCounts"
     th:data-values="${#strings.arrayJoin(lastYearCounts, ',')}">
</div>
<div id="startedCount"
     th:data-values="${startedCount}">
</div>
<div id="completedCount"
     th:data-values="${completedCount}">
</div>

<!-- Chart.js ìŠ¤í¬ë¦½íŠ¸ -->

<th:block layout:fragment="script">
    <script th:inline="javascript">
        const thisYearCounts = [[${thisYearCounts}]];
        const lastYearCounts = [[${lastYearCounts}]];

    console.log(thisYearCounts);
    console.log(lastYearCounts);

    new Chart(document.getElementById("yearChart"), {
        type: "bar",
        data: {
            labels: ["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”",
                     "7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"],
            datasets: [{
                label: "ì™„ë…í•œ ì±… ìˆ˜",
                data: thisYearCounts,
                backgroundColor: "#6c63ff"
            }]
        }
    });


            new Chart(document.getElementById("compareChart"), {
            type: "line",
            data: {
            labels: ["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”",
                     "7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"],
            datasets: [
            {
            label: [[${thisYear}]] + "ë…„",
            data: thisYearCounts,
            borderColor: "#6c63ff",
            backgroundColor: "rgba(108,99,255,0.3)",
            borderWidth: 2,
            tension: 0.3
            },
            {
            label: [[${lastYear}]] + "ë…„",
            data: lastYearCounts,
            borderColor: "#f38b4a",
            backgroundColor: "rgba(243,139,74,0.3)",
            borderWidth: 2,
            tension: 0.3
            }
            ]
            },
            options: {
            scales: {
            y: { ticks: { color: "#fff" } },
            x: { ticks: { color: "#fff" } }
            },
            plugins: { legend: { labels: { color: "#fff" } } }
            }
            });



const readingCount = [[${#lists.size(readingList)}]];
const completedCount = [[${#lists.size(completedList)}]];

const totalRead = readingCount + completedCount;

// ì½ì€ ì±…ì´ 0ê¶Œì´ë©´ ì°¨íŠ¸ ì˜ë¯¸ ì—†ìŒ
if (totalRead > 0) {

    const completedPercent = Math.round(
        (completedCount / totalRead) * 100
    );

    new Chart(document.getElementById("conversionChart"), {
        type: "doughnut",
        data: {
            labels: ["ì™„ë…", "ì½ëŠ” ì¤‘"],
            datasets: [{
                data: [completedPercent, 100 - completedPercent],
                backgroundColor: [
                    "#86db7a",   // ì™„ë…
                    "#6c63ff"    // ì½ëŠ” ì¤‘
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
             width: 400,
             height: 400,
            cutout: "70%",
            plugins: {
                legend: {
                    labels: { color: "#fff" }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + " : " + context.raw + "%";
                        }
                    }
                }
            }
        }
    });
}
    </script>
</th:block>
</html>